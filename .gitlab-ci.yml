stages:
  - build
  - manifest

variables:
  # Use registry.partizani.eu instead of default GitLab registry
  IMAGE_NAME: "registry.partizani.eu/${CI_PROJECT_PATH}"
  REGISTRY_URL: "registry.partizani.eu"

# Build AMD64 image (cross-compilation on ARM64 cluster with QEMU)
# Note: QEMU user-static is installed on all K3s nodes for cross-platform builds
build:amd64:
  stage: build
  image: quay.io/buildah/stable:latest
  script:
    - |
      # Login to GitLab container registry
      echo ${CI_REGISTRY_PASSWORD} | buildah login -u ${CI_REGISTRY_USER} --password-stdin ${REGISTRY_URL}

      # Pull previous image for layer caching (if exists)
      if buildah --storage-driver=overlay pull ${IMAGE_NAME}:latest; then
        CACHE_ARGS="--cache-from ${IMAGE_NAME}:latest"
      else
        CACHE_ARGS=""
      fi

      # Build AMD64 image with caching (if available)
      # QEMU emulation handles AMD64 binary execution on ARM64 hosts
      buildah --storage-driver=overlay bud \
        --arch amd64 \
        --layers \
        $CACHE_ARGS \
        -t ${IMAGE_NAME}:${CI_COMMIT_SHA}-amd64 \
        -t ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-amd64 \
        -f Dockerfile .

      # Push images
      buildah --storage-driver=overlay push ${IMAGE_NAME}:${CI_COMMIT_SHA}-amd64
      buildah --storage-driver=overlay push ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-amd64
  tags:
    - kubernetes
  only:
    - branches
    - tags

# Build ARM64 image
build:arm64:
  stage: build
  image: quay.io/buildah/stable:latest
  script:
    - |
      # Login to GitLab container registry
      echo ${CI_REGISTRY_PASSWORD} | buildah login -u ${CI_REGISTRY_USER} --password-stdin ${REGISTRY_URL}

      # Pull previous image for layer caching (if exists)
      if buildah --storage-driver=overlay pull ${IMAGE_NAME}:latest; then
        CACHE_ARGS="--cache-from ${IMAGE_NAME}:latest"
      else
        CACHE_ARGS=""
      fi

      # Build ARM64 image with caching (if available)
      buildah --storage-driver=overlay bud \
        --arch arm64 \
        --layers \
        $CACHE_ARGS \
        -t ${IMAGE_NAME}:${CI_COMMIT_SHA}-arm64 \
        -t ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-arm64 \
        -f Dockerfile .

      # Push images
      buildah --storage-driver=overlay push ${IMAGE_NAME}:${CI_COMMIT_SHA}-arm64
      buildah --storage-driver=overlay push ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-arm64
  tags:
    - kubernetes
  only:
    - branches
    - tags

# Create multi-arch manifest for commit SHA and branch/tag
manifest:
  stage: manifest
  image: quay.io/buildah/stable:latest
  script:
    - |
      # Login to registry
      echo ${CI_REGISTRY_PASSWORD} | buildah login -u ${CI_REGISTRY_USER} --password-stdin ${REGISTRY_URL}

      # Create and push manifest for commit SHA
      buildah --storage-driver=overlay manifest create ${IMAGE_NAME}:${CI_COMMIT_SHA}
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:${CI_COMMIT_SHA} docker://${IMAGE_NAME}:${CI_COMMIT_SHA}-amd64
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:${CI_COMMIT_SHA} docker://${IMAGE_NAME}:${CI_COMMIT_SHA}-arm64
      buildah --storage-driver=overlay manifest push --all ${IMAGE_NAME}:${CI_COMMIT_SHA} docker://${IMAGE_NAME}:${CI_COMMIT_SHA}

      # Create and push manifest for branch/tag
      buildah --storage-driver=overlay manifest create ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG} docker://${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-amd64
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG} docker://${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-arm64
      buildah --storage-driver=overlay manifest push --all ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG} docker://${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
  tags:
    - kubernetes
  dependencies:
    - build:amd64
    - build:arm64
  only:
    - branches
    - tags

# Create latest tag for main branch
manifest:latest:
  stage: manifest
  image: quay.io/buildah/stable:latest
  script:
    - |
      # Login to registry
      echo ${CI_REGISTRY_PASSWORD} | buildah login -u ${CI_REGISTRY_USER} --password-stdin ${REGISTRY_URL}

      # Create and push manifest for latest
      buildah --storage-driver=overlay manifest create ${IMAGE_NAME}:latest
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:latest docker://${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-amd64
      buildah --storage-driver=overlay manifest add ${IMAGE_NAME}:latest docker://${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}-arm64
      buildah --storage-driver=overlay manifest push --all ${IMAGE_NAME}:latest docker://${IMAGE_NAME}:latest
  tags:
    - kubernetes
  dependencies:
    - build:amd64
    - build:arm64
  only:
    - main
